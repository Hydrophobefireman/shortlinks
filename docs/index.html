<html>
  <head> </head>

  <body>
    <script>
      (function() {
        function zeroHashLen() {
          if (location.hostname === "localhost") return;
          document.body.textContent = "No Link provided..create a link";
          return window.location.replace("https://shorterlinks.herokuapp.com/");
        }
        if (window.location.hash.substr(1).length === 0) {
          return zeroHashLen();
        }
        const currVersion = "7.5.0";
        const path = "/" + currVersion + "/firebase-";
        const scriptNames = ["app", "database"];
        const scripts = scriptNames.map(x => path + x + ".js");

        
        function loadScript(src) {
          return new Promise(resolve => {
            if ("caches" in window) {
              return caches.open("js").then(cache =>
                cache.match(src).then(response => {
                  if (response) {
                    console.log("resolving from cache");
                    response.text().then(x => resolve(x));
                  } else {
                    fetch(src).then(resp => {
                      const clone = resp.clone();
                      cache.put(src, clone);
                      resp.text().then(x => resolve(x));
                    });
                  }
                })
              );
            } else {
              fetch(src)
                .then(x => x.text())
                .then(txt => resolve(txt));
            }
          });
        }
        const loadedPromise = Promise.all(scripts.map(loadScript));
        loadedPromise
          .then(_ =>
            _.forEach(txt => {
              const scr = document.createElement("script");
              scr.text = txt;
              document.head.appendChild(scr);
            })
          )
          .then(() => {
            if (typeof firebase === "undefined")
              throw new Error("Firebase SDK Not Detected");
            firebase.initializeApp({
              apiKey: "AIzaSyDNAOW631nEeOr0KuLYOzzPqTxYWNAOp2A",
              databaseURL: "https://shorterlinks1.firebaseio.com",
              storageBucket: "shorterlinks1.appspot.com",
              authDomain: "shorterlinks1.firebaseapp.com",
              messagingSenderId: "1088482919201",
              projectId: "shorterlinks1"
            });
            const database = firebase.database();
            const init = () => {
              const hash = window.location.hash.substr(1);
              if (hash.length === 0) {
                return zeroHashLen();
              }
              if (hash.length <= 2) {
                return (document.body.textContent =
                  "No URL exists with the given address");
              }
              firebase
                .database()
                .ref("/shortened/" + hash)
                .once("value")
                .then(resp => {
                  const val = resp.val();
                  if (!val) {
                    return (document.body.textContent =
                      "No URL Exists with the Given address");
                  }
                  if (val) {
                    const a  = document.createElement("a");
                    a.href=val;
                    a.textContent=val;
                    const txt = document.createTextNode('Redirecting to ')
                    document.body.innerHTML = '';
                    document.body.appendChild(txt);
                    document.body.appendChild(a);
                    return window.location.replace(val);
                  }
                });
            };
            window.onhashchange = init;
            init();
          });
      })();
    </script>
    <noscript>This is a javascript based url shortener..</noscript>
  </body>
</html>
